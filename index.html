<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>My Shifts</title>
  <style>
    :root{
      --ctrl-h: 46px;
      --ctrl-pad-x: 14px;
      --radius: 10px;
      --border: #1f2937;
      --bg: #0b0f1a;
      --panel: #0f172a;
      --input: #0b1220;
      --text: #e5e7eb;
      --muted: #9ca3af;
    }

    body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}
    .wrap{max-width:900px;margin:24px auto;padding:0 16px}
    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    h1{font-size:1.25rem;margin:0}
    .panel{background:var(--panel);border:1px solid var(--border);border-radius:14px}
    form#shiftForm{display:flex;flex-direction:column;gap:10px;padding:14px}
    .row{display:flex;gap:10px;flex-wrap:wrap}

    input,select,button{
      background:var(--input);color:var(--text);
      border:1px solid var(--border);border-radius:var(--radius);
      height:var(--ctrl-h); padding:0 var(--ctrl-pad-x); box-sizing:border-box;
    }
    input:focus,select:focus{outline:2px solid #334155}
    button{cursor:pointer}
    .btn{padding:0 14px}
    .btn.primary{background:#22c55e;color:#062010;border-color:#16a34a}
    .btn.warn{background:#ef4444;color:#300b0b;border-color:#b91c1c}
    .btn.small{height:36px;padding:0 10px;font-size:.85rem}

    select.small{width:90px;appearance:none;-webkit-appearance:none}
    select.month{min-width:110px}
    select.job{min-width:260px}
    input.day{width:110px;text-align:center}
    input.hm{width:140px;text-align:center;letter-spacing:1px}
    input.hm.invalid{border-color:#ef4444; box-shadow:0 0 0 2px rgba(239,68,68,.25)}

    .row-job select{width:100%;font-size:1rem}
    .row-start, .row-end{align-items:center}
    .last-line-small *{font-size:.95rem}

    .list{padding:10px 12px}
    .monthHdr{color:#a1a1aa;font-weight:600;margin:12px 8px 8px}
    .item{display:flex;gap:12px;background:#101827;border:1px solid var(--border);border-radius:12px;padding:12px;margin-bottom:10px}
    .stripe{width:8px;border-radius:8px;background:#334155}
    .meta{width:60px;text-align:center;color:#9ca3af}
    .meta .day{font-size:.75rem;text-transform:uppercase}
    .meta .date{margin-top:2px;font-size:1.1rem;color:#fff;font-weight:700}
    .content{flex:1}
    .title{font-weight:700;margin-bottom:4px}
    .sub{color:#9ca3af}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:8px}
    .chip{background:#111827;border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:.85rem}
    .actions{display:flex;gap:6px;margin-top:8px}
    .footer{display:flex;justify-content:space-between;align-items:center;padding:10px 14px;color:#9ca3af}

    #checkBar{display:none;padding:8px 14px;border-top:1px dashed var(--border)}
    #checkBar .row{align-items:center}
    #checkBar input[type="date"]{min-width:170px;height:var(--ctrl-h)}

    @media (max-width:520px){
      input.hm{width:120px}
      input.day{width:90px}
      select.month{min-width:98px}
      #checkBar input[type="date"]{min-width:140px}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Your shifts</h1>
      <div style="display:flex;gap:8px">
        <button class="btn warn" id="clearBtn">Clear All</button>
      </div>
    </header>

    <!-- Add form -->
    <section class="panel">
      <form id="shiftForm" autocomplete="off">
        <div class="row row-job">
          <select id="job" class="job" aria-label="Job / Location">
            <option>Field House (Front Desk)</option>
            <option>Field House (South Desk)</option>
            <option>Event Staff</option>
            <option>Chartwell (Southside)</option>
            <option>Meetings</option>
            <option>Others</option>
          </select>
        </div>

        <div class="row">
          <select id="year" class="small" aria-label="Year"></select>
          <select id="month" class="month" aria-label="Month"></select>
          <input id="day" class="day" type="number" min="1" max="31" placeholder="Day" aria-label="Day" />
        </div>

        <div class="row row-start">
          <input id="start" class="hm" type="text" inputmode="numeric" placeholder="Start HH:MM" maxlength="5" aria-label="Start time" />
          <select id="startAmPm" class="small" aria-label="Start AM/PM">
            <option>AM</option><option>PM</option>
          </select>
        </div>

        <div class="row row-end last-line-small">
          <input id="end" class="hm" type="text" inputmode="numeric" placeholder="End HH:MM" maxlength="5" aria-label="End time" />
          <select id="endAmPm" class="small" aria-label="End AM/PM">
            <option>AM</option><option>PM</option>
          </select>
          <button id="addBtn" class="btn primary" type="submit" style="margin-left:auto">Add</button>
        </div>
      </form>
    </section>

    <!-- List + controls -->
    <section class="panel" style="margin-top:14px">
      <div style="padding:10px 14px;display:flex;gap:10px;justify-content:space-between;align-items:center">
        <div id="viewToggle" style="display:flex;gap:6px;flex-wrap:wrap">
          <button id="tabAll" class="btn small" style="opacity:.7">All</button>
          <button id="tabUpcoming" class="btn small">Upcoming</button>
          <button id="tabCheck" class="btn small" style="opacity:.7">Check</button>
        </div>
        <div id="stats" class="chip">0 shifts â€¢ 0.00 hrs</div>
      </div>

      <!-- Appears only when Check is active -->
      <div id="checkBar">
        <div class="row">
          <label for="fromDate" style="color:#9ca3af">From</label>
          <input type="date" id="fromDate" />
          <label for="toDate" style="color:#9ca3af">To</label>
          <input type="date" id="toDate" />
          <button id="applyRange" class="btn primary" type="button">Apply</button>
        </div>
        <small style="color:#9ca3af;display:block;margin-top:6px">
          Lists shifts between these dates (inclusive) and totals them above.
        </small>
      </div>

      <div id="list" class="list"></div>

      <div class="footer">
        <small>Saved in this browser (localStorage).</small>
        <small id="lastSaved">Last saved: never</small>
      </div>
    </section>
  </div>

  <script>
    const key='shift-tracker:v17';
    const $=s=>document.querySelector(s);
    let state=load();
    let editId=null;

    /* Views: 'upcoming' (default), 'all', 'range' */
    let viewMode = 'upcoming';
    let range = { from:null, to:null };

    const pad2 = n => String(n).padStart(2,'0');
    const daysInMonth = (y,m) => new Date(y, m, 0).getDate();

    /* COLORS */
    const JOBS = {
      "Field House (Front Desk)":   "#60a5fa",
      "Event Staff":                "#60a5fa",
      "Field House (South Desk)":   "#34d399",
      "Chartwell (Southside)":      "#f59e0b",
      "Meetings":                   "#a78bfa",
      "Others":                     "#737373",
      "Field House (Front Desk - Event Staff)": "#60a5fa" // legacy key
    };

    /* HOURLY RATES (hidden; used only in Check view) */
    const RATES = {
      "Field House (Front Desk)": 12.41,
      "Field House (South Desk)": 12.41,
      "Event Staff":              12.41,
      "Chartwell (Southside)":    15.00,
      "Meetings":                 0.00,
      "Others":                   10.50,
    };

    function parseHM(t){if(!t)return 0;const [h,m]=t.split(':').map(Number);return h*60+m}
    function hoursBetween(a,b){let s=parseHM(a),e=parseHM(b);if(e<s)e+=24*60;return (e-s)/60}
    function save(){localStorage.setItem(key,JSON.stringify(state));$('#lastSaved').textContent='Last saved: '+new Date().toLocaleString()}
    function load(){try{return JSON.parse(localStorage.getItem(key))||{shifts:[]}}catch{return {shifts:[]}}}
    function weekday(d){return new Date(d+'T00:00:00').toLocaleDateString(undefined,{weekday:'short'})}
    function dayof(d){return new Date(d+'T00:00:00').getDate()}
    function monthLabel(d){return new Date(d+'T00:00:00').toLocaleDateString(undefined,{month:'long'})}
    const money = n => n.toLocaleString(undefined,{style:'currency',currency:'USD'});

    function parse12h(text){
      const m = /^(\d{1,2}):(\d{2})$/.exec(text || '');
      if(!m) return null;
      let h = +m[1], mm = +m[2];
      if(h<1 || h>12 || mm<0 || mm>59) return null;
      return {h, m:mm};
    }
    function to24h(text, ampm){
      const t = parse12h(text); if(!t) return null;
      let h=t.h, m=t.m;
      if(ampm==='PM' && h!==12) h+=12;
      if(ampm==='AM' && h===12) h=0;
      return `${pad2(h)}:${pad2(m)}`;
    }

    function shiftEndDate(s){ return new Date(`${s.date}T${s.end}:00`); }
    function isPastShift(s){ return shiftEndDate(s) < new Date(); }

    /* ----- date selects for Add form ----- */
    const yearSel=$('#year'), monthSel=$('#month'), dayInput=$('#day'), jobSel=$('#job');
    (function populateDateSelectors(){
      const today=new Date();
      const thisYear=today.getFullYear();
      for(let y=thisYear;y<=thisYear+5;y++){yearSel.add(new Option(y,y));}
      const months=[['Jan','01'],['Feb','02'],['Mar','03'],['Apr','04'],['May','05'],['Jun','06'],['Jul','07'],['Aug','08'],['Sep','09'],['Oct','10'],['Nov','11'],['Dec','12']];
      months.forEach(([name,val])=>monthSel.add(new Option(name,val)));
      yearSel.value=thisYear; monthSel.value=pad2(today.getMonth()+1);
      dayInput.value=today.getDate(); dayInput.max = daysInMonth(+yearSel.value, +monthSel.value);
    })();
    function clampDay(){
      const max = daysInMonth(+yearSel.value, +monthSel.value);
      dayInput.max = max;
      if(dayInput.value){ let d = Math.min(Math.max(1, +dayInput.value), max); dayInput.value = d; }
    }
    yearSel.addEventListener('change', clampDay);
    monthSel.addEventListener('change', clampDay);

    /* ----- strong HH:MM mask ----- */
    function attachTimeMask(el){
      el.addEventListener('input', () => {
        let digits = (el.value || '').replace(/\D/g,'').slice(0,4);
        el.value = digits.length >= 3 ? digits.slice(0,2)+':'+digits.slice(2) : digits;
        el.classList.remove('invalid');
      });
      el.addEventListener('keydown', (ev) => {
        const ok = ['Backspace','Delete','ArrowLeft','ArrowRight','Tab','Home','End'];
        if (ok.includes(ev.key) || /^\d$/.test(ev.key)) return; ev.preventDefault();
      });
      el.addEventListener('blur', () => {
        const m = /^(\d{1,2})(?::(\d{1,2}))?$/.exec(el.value || '');
        if(!m){ if(el.value) el.classList.add('invalid'); return; }
        let hh=+m[1], mm=+(m[2]??0);
        if(hh<1||hh>12||mm<0||mm>59){ el.classList.add('invalid'); return; }
        el.value=`${pad2(hh)}:${pad2(mm)}`;
      });
    }
    attachTimeMask($('#start'));
    attachTimeMask($('#end'));

    /* ----- Visible rows based on view ----- */
    function visibleShifts(){
      const sorted = state.shifts.slice()
        .sort((a,b)=>a.date.localeCompare(b.date)||a.start.localeCompare(b.start));

      if(viewMode==='upcoming') return sorted.filter(s=>!isPastShift(s));
      if(viewMode==='range'){
        const from = range.from || '0000-01-01';
        const to   = range.to   || '9999-12-31';
        return sorted.filter(s=>s.date>=from && s.date<=to);
      }
      return sorted;
    }

    /* ----- Render ----- */
    function render(){
      const list=$('#list'); list.innerHTML='';
      const rows = visibleShifts();

      document.getElementById('checkBar').style.display = (viewMode==='range') ? 'block' : 'none';

      if(!rows.length){
        list.innerHTML = `<div style="text-align:center;color:#9ca3af;padding:20px">
          ${viewMode==='upcoming' ? 'No upcoming shifts' : 'No shifts in this view'}
        </div>`;
        updateStats(); return;
      }

      let currentMonth='';
      rows.forEach(s=>{
        const m=monthLabel(s.date);
        if(m!==currentMonth){
          currentMonth=m;
          const h=document.createElement('div');
          h.className='monthHdr'; h.textContent=m; list.appendChild(h);
        }
        list.appendChild(cardFor(s));
      });

      updateStats();
    }

    function cardFor(s){
      const wrap=document.createElement('div'); wrap.className='item';
      const color = JOBS[s.job] || '#334155';
      wrap.innerHTML=`<div class="stripe" style="background:${color}"></div>
        <div class="meta"><div class="day">${weekday(s.date)}</div><div class="date">${dayof(s.date)}</div></div>
        <div class="content">
          <div class="title">${s.job || 'Shift'}</div>
          <div class="sub">${s.date}</div>
          <div class="chips">
            <div class="chip">${s.start} â€“ ${s.end}</div>
            <div class="chip">${hoursBetween(s.start,s.end).toFixed(2)} hrs</div>
          </div>
          <div class="actions">
            <button class="btn small" onclick="startEdit('${s.id}')">Edit</button>
            <button class="btn small warn" onclick="delShift('${s.id}')">Delete</button>
          </div>
        </div>`;
      return wrap;
    }

    /* ----- Stats (with pay only in Check view) ----- */
    function updateStats(){
      const rows = visibleShifts();
      const totalHours = rows.reduce((a,s)=>a+hoursBetween(s.start,s.end),0);
      let label = `${rows.length} shift${rows.length!==1?'s':''} â€¢ ${totalHours.toFixed(2)} hrs`;

      if(viewMode === 'range'){
        const totalPay = rows.reduce((sum,s)=>{
          const rate = (RATES[s.job] ?? RATES['Others']);
          return sum + hoursBetween(s.start,s.end) * rate;
        }, 0);
        label += ` â€¢ ${money(totalPay)}`;
      }
      $('#stats').textContent = label;
    }

    /* ----- Add/Edit/Delete ----- */
    $('#shiftForm').addEventListener('submit',e=>{
      e.preventDefault();
      const year = yearSel.value;
      const month= monthSel.value;
      const day  = pad2(dayInput.value || 1);
      const fullDate = `${year}-${month}-${day}`;

      const startRaw = $('#start').value;
      const endRaw   = $('#end').value;
      const start = to24h(startRaw,$('#startAmPm').value);
      const end   = to24h(endRaw,$('#endAmPm').value);

      const startOk = !!start, endOk = !!end;
      $('#start').classList.toggle('invalid', !startOk && !!startRaw);
      $('#end').classList.toggle('invalid', !endOk && !!endRaw);
      if(!startOk || !endOk){ alert('Please enter time as HH:MM (1â€“12 for hours, 00â€“59 for minutes).'); return; }
      if(hoursBetween(start,end)<=0){ alert('End must be after start (same day).'); return; }

      const job = jobSel.value;

      if(editId){
        const idx=state.shifts.findIndex(s=>s.id===editId);
        if(idx>-1) state.shifts[idx]={...state.shifts[idx],date:fullDate,start,end,job};
        editId=null; $('#addBtn').textContent='Add';
      }else{
        state.shifts.push({id:Math.random().toString(36).slice(2,9),date:fullDate,start,end,job});
      }
      save(); render();
      $('#start').value=''; $('#end').value='';
    });

    function startEdit(id){
      const s=state.shifts.find(x=>x.id===id); if(!s) return;
      const d=new Date(s.date);
      yearSel.value=d.getFullYear();
      monthSel.value=pad2(d.getMonth()+1);
      dayInput.value=d.getDate();
      jobSel.value=s.job || 'Others';

      function setTime(val,boxSel,ampmSel){
        let [h,m]=val.split(':').map(Number);
        let ap='AM'; if(h>=12){ap='PM'; if(h>12)h-=12;} if(h===0)h=12;
        $(boxSel).value=`${pad2(h)}:${pad2(m)}`; $(ampmSel).value=ap;
      }
      setTime(s.start,'#start','#startAmPm');
      setTime(s.end,'#end','#endAmPm');

      editId=id; $('#addBtn').textContent='Update';
      window.scrollTo({top:0,behavior:'smooth'});
    }

    function delShift(id){
      if(!confirm('Delete this shift?')) return;
      state.shifts=state.shifts.filter(s=>s.id!==id);
      save(); render();
    }

    /* ----- Clear All ----- */
    $('#clearBtn').addEventListener('click',()=>{if(!confirm('Remove all shifts?'))return;state={shifts:[]};save();render();});

    /* ----- View toggles ----- */
    function setTabStyles(){
      $('#tabAll').style.opacity       = (viewMode==='all') ? '1' : '.7';
      $('#tabUpcoming').style.opacity  = (viewMode==='upcoming') ? '1' : '.7';
      $('#tabCheck').style.opacity     = (viewMode==='range') ? '1' : '.7';
      document.getElementById('checkBar').style.display = (viewMode==='range') ? 'block' : 'none';
    }
    $('#tabAll').addEventListener('click', () => { viewMode='all'; setTabStyles(); render(); });
    $('#tabUpcoming').addEventListener('click', () => { viewMode='upcoming'; setTabStyles(); render(); });
    $('#tabCheck').addEventListener('click', () => { viewMode='range'; setTabStyles(); render(); });

    /* ----- Range defaults (today â†’ today) & Apply ----- */
    function todayISO(){
      const t=new Date();
      return `${t.getFullYear()}-${pad2(t.getMonth()+1)}-${pad2(t.getDate())}`;
    }
    const fromEl = document.getElementById('fromDate');
    const toEl   = document.getElementById('toDate');
    fromEl.value = todayISO();
    toEl.value   = todayISO();

    document.getElementById('applyRange').addEventListener('click', () => {
      range.from = fromEl.value || null;
      range.to   = toEl.value   || null;
      viewMode = 'range';
      setTabStyles();
      render();
    });

    /* initial render with Upcoming selected */
    setTabStyles();
    render();
  </script>
</body>
</html>
